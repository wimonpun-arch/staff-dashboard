<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard · กองกิจการนิสิต</title>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #fafafa;
    --surface: #ffffff;
    --border: #dbdbdb;
    --text-primary: #262626;
    --text-secondary: #8e8e8e;
    --accent: #0095f6;
    --accent-light: #e8f4fd;
    --gradient: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045);
    --radius: 12px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Kanit', sans-serif; background: var(--bg); color: var(--text-primary); font-weight: 300; min-height: 100vh; }

  /* Header */
  .header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 24px; display: flex; align-items: center; justify-content: space-between; height: 60px; position: sticky; top: 0; z-index: 100; }
  .header-logo { display: flex; align-items: center; gap: 10px; }
  .dot-bar { width: 28px; height: 20px; display: flex; flex-direction: column; gap: 4px; justify-content: center; }
  .dot-bar span { display: block; height: 2px; border-radius: 2px; background: var(--text-primary); }
  .dot-bar span:nth-child(2) { width: 70%; }
  .header h1 { font-size: 16px; font-weight: 600; letter-spacing: 0.5px; }
  .header h1 span { background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .header-right { font-size: 12px; color: var(--text-secondary); }
  #lastUpdated { font-weight: 500; color: var(--accent); }

  /* Layout */
  .main { max-width: 1100px; margin: 0 auto; padding: 28px 20px; }

  /* Filter */
  .filter-bar { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px 20px; margin-bottom: 24px; display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end; }
  .filter-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 160px; }
  .filter-group label { font-size: 11px; font-weight: 500; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.8px; }
  .filter-group select { font-family: 'Kanit', sans-serif; font-size: 13px; border: 1px solid var(--border); border-radius: 8px; padding: 8px 28px 8px 12px; background: var(--bg); color: var(--text-primary); cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%238e8e8e' stroke-width='1.5' fill='none'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; transition: border-color 0.2s; }
  .filter-group select:focus { outline: none; border-color: var(--accent); }
  .btn-refresh { font-family: 'Kanit', sans-serif; font-size: 13px; font-weight: 500; background: var(--accent); color: #fff; border: none; border-radius: 8px; padding: 9px 20px; cursor: pointer; transition: opacity 0.2s; white-space: nowrap; height: 36px; align-self: flex-end; }
  .btn-refresh:hover { opacity: 0.88; }
  .btn-refresh:disabled { opacity: 0.6; cursor: not-allowed; }

  /* Stats */
  .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px 20px; }
  .stat-label { font-size: 11px; font-weight: 500; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px; }
  .stat-value { font-size: 26px; font-weight: 600; line-height: 1; }
  .stat-value.accent { color: var(--accent); }
  .stat-sub { font-size: 12px; color: var(--text-secondary); margin-top: 5px; }

  /* Charts */
  .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
  .chart-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 22px 22px 18px; }
  .chart-card.wide { grid-column: 1 / -1; }
  .chart-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
  .chart-sub { font-size: 11px; color: var(--text-secondary); margin-bottom: 16px; }
  .chart-wrap { position: relative; height: 240px; }
  .chart-wrap.tall { height: 300px; }

  /* Table */
  .table-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 22px; margin-bottom: 16px; }
  .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
  .table-header-left { display: flex; flex-direction: column; gap: 2px; }
  .table-wrap { overflow-x: auto; }

  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; padding: 8px 12px; font-size: 11px; font-weight: 500; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.7px; border-bottom: 1px solid var(--border); white-space: nowrap; }
  th.sortable { cursor: pointer; user-select: none; }
  th.sortable:hover { color: var(--accent); }
  th.sort-active { color: var(--accent); }
  .sort-icon { margin-left: 4px; font-size: 10px; }
  td { padding: 10px 12px; border-bottom: 1px solid #f0f0f0; font-weight: 300; vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: #f9f9f9; }
  .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 500; background: var(--accent-light); color: var(--accent); }

  /* Pagination */
  .pagination { display: flex; align-items: center; justify-content: center; gap: 6px; margin-top: 18px; flex-wrap: wrap; }
  .page-btn { font-family: 'Kanit', sans-serif; font-size: 13px; border: 1px solid var(--border); border-radius: 8px; padding: 6px 12px; background: var(--surface); color: var(--text-primary); cursor: pointer; transition: all 0.15s; min-width: 36px; text-align: center; }
  .page-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
  .page-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); font-weight: 500; }
  .page-btn:disabled { opacity: 0.35; cursor: not-allowed; }
  .page-info { font-size: 12px; color: var(--text-secondary); padding: 0 4px; }

  /* Loading */
  .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(250,250,250,0.75); backdrop-filter: blur(4px); z-index: 200; align-items: center; justify-content: center; flex-direction: column; gap: 14px; }
  .loading-overlay.show { display: flex; }
  .spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { font-size: 13px; color: var(--text-secondary); }
  .empty-state { text-align: center; padding: 48px 20px; color: var(--text-secondary); font-size: 13px; }

  @media (max-width: 700px) {
    .stats-row { grid-template-columns: 1fr 1fr; }
    .charts-grid { grid-template-columns: 1fr; }
    .chart-card.wide { grid-column: 1; }
  }
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text">กำลังโหลดข้อมูล...</div>
</div>

<header class="header">
  <div class="header-logo">
    <div class="dot-bar"><span></span><span></span><span></span></div>
    <h1><span>กองกิจการนิสิต</span> · Analytics</h1>
  </div>
  <div class="header-right">อัพเดทล่าสุด: <span id="lastUpdated">—</span></div>
</header>

<main class="main">

  <!-- Filters -->
  <div class="filter-bar">
    <div class="filter-group">
      <label>ปี (Year)</label>
      <select id="filterYear" onchange="applyFilters()">
        <option value="all">ทุกปี</option>
      </select>
    </div>
    <div class="filter-group">
      <label>เดือน (Month)</label>
      <select id="filterMonth" onchange="applyFilters()">
        <option value="all">ทุกเดือน</option>
        <option value="1">มกราคม</option><option value="2">กุมภาพันธ์</option>
        <option value="3">มีนาคม</option><option value="4">เมษายน</option>
        <option value="5">พฤษภาคม</option><option value="6">มิถุนายน</option>
        <option value="7">กรกฎาคม</option><option value="8">สิงหาคม</option>
        <option value="9">กันยายน</option><option value="10">ตุลาคม</option>
        <option value="11">พฤศจิกายน</option><option value="12">ธันวาคม</option>
      </select>
    </div>
    <div class="filter-group">
      <label>บุคลากร</label>
      <select id="filterPerson" onchange="applyFilters()">
        <option value="all">ทุกคน</option>
      </select>
    </div>
    <button class="btn-refresh" onclick="fetchData()" id="btnRefresh">↻ รีเฟรชข้อมูล</button>
  </div>

  <!-- Stats -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-label">จำนวนงานทั้งหมด</div>
      <div class="stat-value accent" id="statTotal">—</div>
      <div class="stat-sub">รายการ</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">รวมชั่วโมงปฏิบัติงาน</div>
      <div class="stat-value" id="statHours">—</div>
      <div class="stat-sub">ชั่วโมง</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">เฉลี่ยต่องาน</div>
      <div class="stat-value" id="statAvg">—</div>
      <div class="stat-sub">ชั่วโมง / รายการ</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">จำนวนบุคลากร</div>
      <div class="stat-value" id="statPeople">—</div>
      <div class="stat-sub">คน</div>
    </div>
  </div>

  <!-- Charts -->
  <div class="charts-grid">
    <div class="chart-card wide">
      <div class="chart-title">ชั่วโมงการปฏิบัติงานรายเดือน</div>
      <div class="chart-sub">จำนวนชั่วโมงสะสมแยกตามเดือน</div>
      <div class="chart-wrap tall"><canvas id="chartMonthly"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">ชั่วโมงปฏิบัติงานแยกบุคลากร</div>
      <div class="chart-sub">สรุปรวมแต่ละคน</div>
      <div class="chart-wrap"><canvas id="chartPerson"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">จำนวนงานแยกบุคลากร</div>
      <div class="chart-sub">สัดส่วนงานที่ได้รับมอบหมาย</div>
      <div class="chart-wrap"><canvas id="chartDonut"></canvas></div>
    </div>
  </div>

  <!-- Table -->
  <div class="table-card">
    <div class="table-header">
      <div class="table-header-left">
        <div class="chart-title">รายการงานที่ได้รับมอบหมาย</div>
        <div class="chart-sub" id="tableCount">—</div>
      </div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th class="sortable sort-active" id="thDate" onclick="toggleSort()">
              วันที่ <span class="sort-icon" id="sortIcon">↑</span>
            </th>
            <th>ชื่อ-สกุล</th>
            <th>รายละเอียดงาน</th>
            <th>ชั่วโมง</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="5"><div class="empty-state">กำลังโหลด...</div></td></tr>
        </tbody>
      </table>
    </div>
    <div class="pagination" id="pagination"></div>
  </div>

</main>

<script>
const SHEET_ID   = '1_DzToU5iXgzwOB9WyguLJRn6rfUYaBoUJfMNsVbakp8';
const SHEET_NAME = 'การตอบแบบฟอร์ม 1';
const API_URL    = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
const PER_PAGE   = 10;

let rawData      = [];
let filteredData = [];
let currentPage  = 1;
let sortDir      = 'asc'; // 'asc' = เก่า→ใหม่, 'desc' = ใหม่→เก่า
let charts       = {};

const MONTH_NAMES = ['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.'];
const PALETTE     = ['#0095f6','#fd1d1d','#fcb045','#833ab4','#30cfd0','#667eea','#f093fb','#4facfe','#43e97b','#fa709a'];
const CFONT       = { family: 'Kanit', size: 12, weight: '300' };

// ── DATE PARSER ──────────────────────────────────────────
function parseDate(raw) {
  if (!raw) return null;
  const s = String(raw).trim();

  // gviz: Date(2024,0,15)
  const gv = s.match(/Date\((\d+),(\d+),(\d+)\)/);
  if (gv) return new Date(+gv[1], +gv[2], +gv[3]);

  // DD/MM/YYYY (รองรับ พ.ศ.)
  const sl = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
  if (sl) { let y = +sl[3]; if (y > 2500) y -= 543; return new Date(y, +sl[2]-1, +sl[1]); }

  // YYYY-MM-DD
  const is = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (is) { let y = +is[1]; if (y > 2500) y -= 543; return new Date(y, +is[2]-1, +is[3]); }

  const d = new Date(s);
  return isNaN(d) ? null : d;
}

function formatDateTH(date) {
  if (!date) return '—';
  const d = date.getDate();
  const m = MONTH_NAMES[date.getMonth()];
  const y = date.getFullYear() + 543;
  return `${d} ${m} ${y}`;
}

// ── FETCH ────────────────────────────────────────────────
async function fetchData() {
  setLoading(true);
  try {
    const res  = await fetch(API_URL + '&t=' + Date.now());
    const text = await res.text();
    const json = JSON.parse(text.replace(/^[^\(]*\(/, '').replace(/\);\s*$/, ''));

    rawData = json.table.rows.slice(1).map(r => {
      const c       = r.c;
      const dcell   = c[3];
      let dateRaw   = '', dateObj = null;
      if (dcell) {
        if (typeof dcell.v === 'string') {
          dateObj = parseDate(dcell.v) || parseDate(dcell.f);
          dateRaw = dcell.f || dcell.v;
        } else if (dcell.f) {
          dateRaw = dcell.f;
          dateObj = parseDate(dcell.f);
        }
      }
      const hours = parseFloat(String(c[5]?.v ?? c[5]?.f ?? 0).replace(/[^\d.]/g, '')) || 0;
      return {
        name:    c[1]?.v || '',
        detail:  c[2]?.v || '',
        dateRaw,
        date:    dateObj,
        hours,
      };
    }).filter(r => r.name);

    populateFilters();
    applyFilters();
    document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString('th-TH');
  } catch(e) {
    console.error(e);
    alert('ไม่สามารถโหลดข้อมูลได้\nกรุณาตรวจสอบว่า Google Sheet เปิดสิทธิ์ "Anyone with the link → Viewer" แล้ว');
  } finally {
    setLoading(false);
  }
}

// ── FILTERS ─────────────────────────────────────────────
function populateFilters() {
  const years = [...new Set(rawData.map(r => r.date?.getFullYear()).filter(Boolean))].sort();
  const selY  = document.getElementById('filterYear');
  const curY  = selY.value;
  selY.innerHTML = '<option value="all">ทุกปี</option>';
  years.forEach(y => {
    const o = new Option(`${y+543} (พ.ศ.)`, y);
    if (String(y) === curY) o.selected = true;
    selY.appendChild(o);
  });

  const people = [...new Set(rawData.map(r => r.name).filter(Boolean))].sort();
  const selP   = document.getElementById('filterPerson');
  const curP   = selP.value;
  selP.innerHTML = '<option value="all">ทุกคน</option>';
  people.forEach(p => {
    const o = new Option(p, p);
    if (p === curP) o.selected = true;
    selP.appendChild(o);
  });
}

function applyFilters() {
  const year   = document.getElementById('filterYear').value;
  const month  = document.getElementById('filterMonth').value;
  const person = document.getElementById('filterPerson').value;

  filteredData = rawData.filter(r => {
    if (year   !== 'all' && r.date?.getFullYear() !== +year)    return false;
    if (month  !== 'all' && r.date?.getMonth()+1  !== +month)   return false;
    if (person !== 'all' && r.name !== person)                  return false;
    return true;
  });

  sortData();
}

// ── SORT ─────────────────────────────────────────────────
function toggleSort() {
  sortDir = sortDir === 'asc' ? 'desc' : 'asc';
  document.getElementById('sortIcon').textContent = sortDir === 'asc' ? '↑' : '↓';
  sortData();
}

function sortData() {
  filteredData.sort((a, b) => {
    const ta = a.date ? a.date.getTime() : 0;
    const tb = b.date ? b.date.getTime() : 0;
    return sortDir === 'asc' ? ta - tb : tb - ta;
  });
  currentPage = 1;
  updateStats(filteredData);
  updateCharts(filteredData);
  updateTable();
}

// ── STATS ────────────────────────────────────────────────
function updateStats(data) {
  const total  = data.length;
  const hours  = data.reduce((s,r) => s + r.hours, 0);
  document.getElementById('statTotal').textContent  = total.toLocaleString('th-TH');
  document.getElementById('statHours').textContent  = hours.toLocaleString('th-TH', {minimumFractionDigits:1,maximumFractionDigits:1});
  document.getElementById('statAvg').textContent    = total ? (hours/total).toFixed(1) : '0';
  document.getElementById('statPeople').textContent = new Set(data.map(r=>r.name)).size;
}

// ── CHARTS ───────────────────────────────────────────────
function updateCharts(data) {
  // Monthly bar
  const mmap = {};
  data.forEach(r => {
    if (!r.date) return;
    const k = `${r.date.getFullYear()}-${String(r.date.getMonth()+1).padStart(2,'0')}`;
    mmap[k] = (mmap[k]||0) + r.hours;
  });
  const mkeys = Object.keys(mmap).sort();
  destroyChart('monthly');
  if (mkeys.length) {
    charts.monthly = new Chart(document.getElementById('chartMonthly'), {
      type: 'bar',
      data: {
        labels: mkeys.map(k => { const [y,m]=k.split('-'); return `${MONTH_NAMES[+m-1]} ${+y+543}`; }),
        datasets: [{ label:'ชั่วโมง', data: mkeys.map(k=>+(mmap[k].toFixed(1))), backgroundColor:'rgba(0,149,246,0.15)', borderColor:'#0095f6', borderWidth:2, borderRadius:6, borderSkipped:false }]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, tooltip:{callbacks:{label:c=>` ${c.raw} ชั่วโมง`},titleFont:CFONT,bodyFont:CFONT} }, scales:{ x:{grid:{display:false},ticks:{font:CFONT,color:'#8e8e8e',maxRotation:45}}, y:{grid:{color:'#f0f0f0'},ticks:{font:CFONT,color:'#8e8e8e'},beginAtZero:true} } }
    });
  }

  // Person hours
  const pmap = {};
  data.forEach(r => { pmap[r.name] = (pmap[r.name]||0) + r.hours; });
  const psorted = Object.entries(pmap).sort((a,b)=>b[1]-a[1]);
  destroyChart('person');
  charts.person = new Chart(document.getElementById('chartPerson'), {
    type:'bar',
    data:{ labels:psorted.map(e=>e[0]), datasets:[{ label:'ชั่วโมง', data:psorted.map(e=>+(e[1].toFixed(1))), backgroundColor:PALETTE.map(c=>c+'30'), borderColor:PALETTE, borderWidth:2, borderRadius:6, borderSkipped:false }] },
    options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>` ${c.raw} ชั่วโมง`},titleFont:CFONT,bodyFont:CFONT}}, scales:{ x:{grid:{color:'#f0f0f0'},ticks:{font:CFONT,color:'#8e8e8e'},beginAtZero:true}, y:{grid:{display:false},ticks:{font:CFONT,color:'#8e8e8e'}} } }
  });

  // Donut count
  const dmap = {};
  data.forEach(r => { dmap[r.name] = (dmap[r.name]||0) + 1; });
  const dsorted = Object.entries(dmap).sort((a,b)=>b[1]-a[1]);
  destroyChart('donut');
  charts.donut = new Chart(document.getElementById('chartDonut'), {
    type:'doughnut',
    data:{ labels:dsorted.map(e=>e[0]), datasets:[{ data:dsorted.map(e=>e[1]), backgroundColor:PALETTE, borderWidth:2, borderColor:'#fff', hoverOffset:6 }] },
    options:{ responsive:true, maintainAspectRatio:false, cutout:'65%', plugins:{ legend:{position:'bottom',labels:{font:CFONT,color:'#8e8e8e',boxWidth:12,padding:12}}, tooltip:{callbacks:{label:c=>` ${c.label}: ${c.raw} งาน`},titleFont:CFONT,bodyFont:CFONT} } }
  });
}

function destroyChart(key) { if (charts[key]) { charts[key].destroy(); delete charts[key]; } }

// ── TABLE + PAGINATION ───────────────────────────────────
function updateTable() {
  const total      = filteredData.length;
  const totalPages = Math.max(1, Math.ceil(total / PER_PAGE));
  if (currentPage > totalPages) currentPage = totalPages;

  const start    = (currentPage-1) * PER_PAGE;
  const end      = Math.min(start + PER_PAGE, total);
  const pageData = filteredData.slice(start, end);

  document.getElementById('tableCount').textContent =
    total ? `แสดง ${start+1}–${end} จากทั้งหมด ${total} รายการ` : 'ไม่พบข้อมูล';

  const tbody = document.getElementById('tableBody');
  if (!total) {
    tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state">ไม่พบข้อมูลที่ตรงกับเงื่อนไข</div></td></tr>`;
    document.getElementById('pagination').innerHTML = '';
    return;
  }

  tbody.innerHTML = pageData.map((r, i) => `
    <tr>
      <td style="color:var(--text-secondary);white-space:nowrap">${start+i+1}</td>
      <td style="white-space:nowrap;color:var(--text-secondary)">${formatDateTH(r.date)}</td>
      <td style="font-weight:500;white-space:nowrap">${r.name}</td>
      <td>${r.detail || '—'}</td>
      <td><span class="badge">${r.hours} ชม.</span></td>
    </tr>`).join('');

  renderPagination(totalPages);
}

function renderPagination(totalPages) {
  const el = document.getElementById('pagination');
  if (totalPages <= 1) { el.innerHTML = ''; return; }

  // สร้าง smart page range
  const pages = [];
  for (let i = 1; i <= totalPages; i++) {
    if (i === 1 || i === totalPages || (i >= currentPage-2 && i <= currentPage+2)) {
      pages.push(i);
    } else if (pages[pages.length-1] !== '...') {
      pages.push('...');
    }
  }

  el.innerHTML = `
    <button class="page-btn" onclick="goPage(${currentPage-1})" ${currentPage===1?'disabled':''}>‹ ก่อนหน้า</button>
    ${pages.map(p => p === '...'
      ? `<span class="page-info">…</span>`
      : `<button class="page-btn ${p===currentPage?'active':''}" onclick="goPage(${p})">${p}</button>`
    ).join('')}
    <button class="page-btn" onclick="goPage(${currentPage+1})" ${currentPage===totalPages?'disabled':''}>ถัดไป ›</button>
    <span class="page-info">หน้า ${currentPage} / ${totalPages}</span>
  `;
}

function goPage(p) {
  const totalPages = Math.ceil(filteredData.length / PER_PAGE);
  if (p < 1 || p > totalPages) return;
  currentPage = p;
  updateTable();
  document.querySelector('.table-card').scrollIntoView({ behavior:'smooth', block:'start' });
}

// ── UTILS ────────────────────────────────────────────────
function setLoading(on) {
  document.getElementById('loadingOverlay').classList.toggle('show', on);
  const btn = document.getElementById('btnRefresh');
  btn.textContent = on ? '⏳ กำลังโหลด...' : '↻ รีเฟรชข้อมูล';
  btn.disabled = on;
}

// ── INIT ─────────────────────────────────────────────────
fetchData();
setInterval(fetchData, 5 * 60 * 1000);
</script>
</body>
</html>
